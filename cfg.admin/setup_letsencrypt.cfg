#
# This is to setup Letsencrypt on the ubuntu server 16.04
#
# NOTES:
#   - For interactive cmd, please append "pwd" at the end.
#   - Built-in func: MYE_UPDATE_FILE
#   - Built-in variables:
#         CFG_ROOT_DIR, CURRENT_DATE, CURRENT_TIME, TOOL_ROOT_DIR
#
#
# Prerequisites:
#

#
# The global variables for this project
#

REPO_ROOT := $HOME/myRepos
WEBSITE_ROOT := /var/www/wjw
DOMAIN_NAME := wjw.vancasoft.com
DOMAIN_EMAIL := admin@vancasoft.com

# The default password for all the service users

#
# Prepare installing
#

STEP_011.CMD:= mkdir -p $::TQ_CONFIG{REPO_ROOT}
STEP_011.description:= To create the repo root if not exist

#
# Now install Letsencrypt
#

STEP_021.CMD:= sudo apt install -y git
STEP_021.description:= To install the supporting packages - libpython2.7-dev

STEP_022.CMD:= sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt
STEP_022.description:= To clone the repo of Letsencrypt

STEP_023.CMD:= sudo /opt/letsencrypt/letsencrypt-auto --debug
STEP_023.description:= To run the installer of Letsencrypt

STEP_025.CMD:= sudo mkdir -p /etc/letsencrypt; echo "rsa-key-size = 4096" | sudo tee -a /etc/letsencrypt/config.ini; sudo sed -i -e "$ a\\email = $::TQ_CONFIG{ADMIN_EMAIL}" /etc/letsencrypt/config.ini
STEP_025.description:= To create the configuration file

STEP_026.CMD:= sudo /opt/letsencrypt/letsencrypt-auto certonly --webroot -w $::TQ_CONFIG{WEBSITE_ROOT} -d $::TQ_CONFIG{DOMAIN_NAME} --config /etc/letsencrypt/config.ini --agree-tos
STEP_026.description:= To encrypt the domain

#
# Automatically renew the cert - it only lasts 90 days
#
STEP_039.CMD := echo "/opt/letsencrypt/letsencrypt-auto renew --config /etc/letsencrypt/config.ini --agree-tos && apachectl graceful"; pwd
STEP_039.description := To automatically renew the cert - put it into your cron
